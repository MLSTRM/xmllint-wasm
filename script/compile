#!/bin/bash

function use_emcc() {
emcc -Os -s WASM=1 -s EMULATE_FUNCTION_POINTER_CASTS=1 \

	-s MODULARIZE=true \
	-s NO_EXIT_RUNTIME=0 \
	-s EXPORT_NAME=Module \
	--closure 1 \
	--memory-init-file 0 \
	./build/xmllint.o ./build/.libs/libxml2.a ./libz.a \
	--pre-js ./build/worker-pre-js.js
}

mkdir -p build

function compile_js() {
	local compile_env="$1"

	awk -f ./script/preprocess-js.awk -v env="$compile_env" \
		./src/pre.js  > ./build/worker-pre-js.js

	awk -f ./script/preprocess-js.awk -v env="$compile_env" \
		./src/index.js  > "./xmllint-$compile_env.js"
}

# Browser build
compile_js browser
use_emcc -s ENVIRONMENT=web -o xmllint-browser.js

# Node build
compile_js node
use_emcc -s ENVIRONMENT=node,worker -o xmllint-node.js
